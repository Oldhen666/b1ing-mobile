<script>
const WP_BASE = "https://b1ing.ca";
const HOT_SUFFIX = "_m_top";
const apiBase = WP_BASE + "/wp-json/wc/store/v1";

// ===== Hot Picks =====
function pickHotIcon(slug) {
  const base = slug.replace(HOT_SUFFIX, "");
  if (base.includes("sofa")) return "üõãÔ∏è";
  if (base.includes("roof") || base.includes("tent")) return "‚õ∫";
  if (base.includes("walk")) return "üö∂";
  if (base.includes("bean")) return "ü´ò";
  return "‚≠ê";
}

async function loadHotPicks() {
  const strip = document.getElementById("hot-strip");
  strip.innerHTML = '<div class="hot-loading">Loading‚Ä¶</div>';

  try {
    const res = await fetch(`${apiBase}/products/categories?per_page=100`,
      { credentials: "include" }
    );
    const cats = await res.json();

    const hotCats = cats.filter(c => c.slug.endsWith(HOT_SUFFIX) && c.count > 0);
    strip.innerHTML = "";

    if (!hotCats.length) {
      strip.innerHTML = '<div class="hot-empty">No hot picks yet.</div>';
      return;
    }

    hotCats.forEach(cat => {
      const icon = pickHotIcon(cat.slug);
      const tag = cat.description || "Hot pick";

      const card = document.createElement("div");
      card.className = "hot-card";
      card.innerHTML = `
        <div class="hot-icon">${icon}</div>
        <div class="hot-name">${cat.name}</div>
        <div class="hot-tag">${tag}</div>
      `;
      card.onclick = () => window.location.href = cat.permalink;
      strip.appendChild(card);
    });

  } catch (e) {
    console.error(e);
    strip.innerHTML = '<div class="hot-empty">Failed to load hot picks.</div>';
  }
}

// ===== Latest Products =====
async function loadMobileCategories() {
  const res = await fetch(`${apiBase}/products/categories?per_page=100`);
  const cats = await res.json();
  return cats.filter(c => c.slug.endsWith("_m") || c.slug.includes("_m_"));
}

async function loadProductsByCategories(ids) {
  const url = `${apiBase}/products?per_page=50&category=${ids.join(",")}`;
  const res = await fetch(url);
  return res.json();
}

function mapProductToCard(p) {
  return {
    name: p.name,
    price: p.prices.price / 100,
    emoji: "üõí",
    image: p.images?.[0]?.src ?? "",
    rating: p.average_rating || 4.7,
    reviews: p.rating_count || 0,
    permalink: p.permalink
  };
}

let feedData = [];
let loadedCount = 0;
const pageSize = 10;
const feedGrid = document.getElementById("feedGrid");
const feedLoading = document.getElementById("feedLoading");

function createCard(item) {
  const card = document.createElement("div");
  card.className = "product-card";

  card.innerHTML = `
    <div class="product-img"><span>${item.emoji}</span></div>
    <div class="product-body">
      <div class="product-name">${item.name}</div>
      <div class="product-price-row">
        <div class="product-price">CA$ ${item.price.toFixed(2)}</div>
        <div class="product-tag">New</div>
      </div>
      <div class="product-meta">
        <div class="product-rating">‚≠ê ${item.rating} ¬∑ ${item.reviews} reviews</div>
        <div class="product-time">New</div>
      </div>
    </div>
  `;

  card.onclick = () => window.location.href = item.permalink;

  return card;
}

function renderMore() {
  const end = Math.min(loadedCount + pageSize, feedData.length);
  for (let i = loadedCount; i < end; i++) {
    feedGrid.appendChild(createCard(feedData[i]));
  }
  loadedCount = end;

  feedLoading.textContent =
    loadedCount >= feedData.length ? "You reached the end" : "Scroll to load more";
}

async function initFeed() {
  feedLoading.textContent = "Loading‚Ä¶";

  const cats = await loadMobileCategories();
  const ids = cats.map(c => c.id);
  const products = await loadProductsByCategories(ids);

  feedData = products.map(mapProductToCard);
  feedData.sort(() => Math.random() - 0.5);

  feedGrid.innerHTML = "";
  loadedCount = 0;
  renderMore();
}

// Infinite scroll
window.addEventListener("scroll", () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 300) {
    renderMore();
  }
});

// Init all
window.onload = () => {
  loadHotPicks();
  initFeed();
};
</script>
